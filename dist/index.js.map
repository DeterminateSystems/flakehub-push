{"version":3,"sources":["../ts/index.ts"],"sourcesContent":["import * as actionsCore from \"@actions/core\";\nimport * as actionsExec from \"@actions/exec\";\nimport { ActionOptions, IdsToolbox, inputs } from \"detsys-ts\";\n\nconst EVENT_EXECUTION_FAILURE = \"execution_failure\";\n\nconst VISIBILITY_OPTIONS = [\"public\", \"unlisted\", \"private\"];\n\ntype Visibility = \"public\" | \"unlisted\" | \"private\";\n\ntype ExecutionEnvironment = {\n  FLAKEHUB_PUSH_VISIBILITY?: string;\n  FLAKEHUB_PUSH_TAG?: string;\n  FLAKEHUB_PUSH_HOST?: string;\n  FLAKEHUB_PUSH_LOG_DIRECTIVES?: string;\n  FLAKEHUB_PUSH_LOGGER?: string;\n  FLAKEHUB_PUSH_GITHUB_TOKEN?: string;\n  FLAKEHUB_PUSH_NAME?: string;\n  FLAKEHUB_PUSH_REPOSITORY?: string;\n  FLAKEHUB_PUSH_DIRECTORY?: string;\n  FLAKEHUB_PUSH_GIT_ROOT?: string;\n  FLAKEHUB_PUSH_EXTRA_LABELS?: string;\n  FLAKEHUB_PUSH_SPDX_EXPRESSION?: string;\n  FLAKEHUB_PUSH_ERROR_ON_CONFLICT?: string;\n  FLAKEHUB_PUSH_INCLUDE_OUTPUT_PATHS?: string;\n  FLAKEHUB_PUSH_ROLLING?: string;\n  FLAKEHUB_PUSH_MIRROR?: string;\n  FLAKEHUB_PUSH_ROLLING_MINOR?: string;\n};\n\nclass FlakeHubPushAction {\n  idslib: IdsToolbox;\n\n  // Action inputs translated into environment variables to pass to flakehub-push\n  private tag: string;\n  private host: string;\n  private logDirectives: string;\n  private logger: string;\n  private gitHubToken: string;\n  private repository: string;\n  private directory: string;\n  private gitRoot: string;\n  private spdxExpression: string;\n  private errorOnConflict: boolean;\n  private includeOutputPaths: boolean;\n  private rolling: boolean;\n  private mirror: boolean;\n  private name: string | null;\n  private rollingMinor: number | null;\n\n  constructor() {\n    const options: ActionOptions = {\n      name: \"flakehub-push\",\n      fetchStyle: \"gh-env-style\",\n      diagnosticsUrl: new URL(\n        \"https://install.determinate.systems/flakehub-push/telemetry\",\n      ),\n      legacySourcePrefix: \"flakehub-push\",\n      requireNix: \"fail\",\n    };\n\n    this.idslib = new IdsToolbox(options);\n\n    // Inputs translated into environment variables for flakehub-push\n    this.tag = inputs.getString(\"tag\");\n    this.host = inputs.getString(\"host\");\n    this.logDirectives = inputs.getString(\"log-directives\");\n    this.logger = inputs.getString(\"logger\");\n    this.gitHubToken = inputs.getString(\"github-token\");\n    this.repository = inputs.getString(\"repository\");\n    this.directory = inputs.getString(\"directory\");\n    this.gitRoot = inputs.getString(\"git-root\");\n    this.spdxExpression = inputs.getString(\"spdx-expression\");\n    this.errorOnConflict = inputs.getBool(\"error-on-conflict\");\n    this.includeOutputPaths = inputs.getBool(\"include-output-paths\");\n    this.rolling = inputs.getBool(\"rolling\");\n    this.mirror = inputs.getBool(\"mirror\");\n    this.name = inputs.getStringOrNull(\"name\");\n    this.rollingMinor = inputs.getNumberOrNull(\"rolling-minor\");\n  }\n\n  // extra-tags is deprecated but we still honor it\n  private get extraLabels(): string {\n    const labels = inputs.getString(\"extra-labels\"); // current input name\n    const tags = inputs.getString(\"extra-tags\"); // deprecated input name\n\n    // If `extra-labels` is set to something use it, otherwise use `extra-tags`.\n    // It `extra-tags` is also not set, which means that it's an empty string, that's\n    // still valid, as the flakehub-push CLI expects a comma-separated list here.\n    return labels !== \"\" ? labels : tags;\n  }\n\n  // We first check for a value using the `source-binary` input and fall back to the\n  // now-deprecated `flakehub-push-binary`\n  private get sourceBinary(): string | null {\n    const sourceBinaryInput = inputs.getStringOrNull(\"source-binary\");\n    const flakeHubPushBinaryInput = inputs.getStringOrNull(\n      \"flakehub-push-binary\",\n    );\n\n    return sourceBinaryInput !== \"\"\n      ? sourceBinaryInput\n      : flakeHubPushBinaryInput;\n  }\n\n  private get visibility(): Visibility {\n    const visibility = inputs.getString(\"visibility\");\n    if (!VISIBILITY_OPTIONS.includes(visibility)) {\n      actionsCore.setFailed(\n        `Visibility option \\`${visibility}\\` not recognized. Available options: ${VISIBILITY_OPTIONS.map((opt) => `\\`${opt}\\``).join(\", \")}.`,\n      );\n    }\n    return visibility as Visibility;\n  }\n\n  private async executionEnvironment(): Promise<ExecutionEnvironment> {\n    const env: ExecutionEnvironment = {};\n\n    env.FLAKEHUB_PUSH_VISIBILITY = this.visibility;\n    env.FLAKEHUB_PUSH_TAG = this.tag;\n    env.FLAKEHUB_PUSH_HOST = this.host;\n    env.FLAKEHUB_PUSH_LOG_DIRECTIVES = this.logDirectives;\n    env.FLAKEHUB_PUSH_LOGGER = this.logger;\n    env.FLAKEHUB_PUSH_GITHUB_TOKEN = this.gitHubToken;\n    env.FLAKEHUB_PUSH_REPOSITORY = this.repository;\n    env.FLAKEHUB_PUSH_DIRECTORY = this.directory;\n    env.FLAKEHUB_PUSH_GIT_ROOT = this.gitRoot;\n    // not included: the now-deprecated FLAKEHUB_PUSH_EXTRA_TAGS\n    env.FLAKEHUB_PUSH_EXTRA_LABELS = this.extraLabels;\n    env.FLAKEHUB_PUSH_SPDX_EXPRESSION = this.spdxExpression;\n    env.FLAKEHUB_PUSH_ERROR_ON_CONFLICT = this.errorOnConflict.toString();\n    env.FLAKEHUB_PUSH_INCLUDE_OUTPUT_PATHS = this.includeOutputPaths.toString();\n    env.FLAKEHUB_PUSH_ROLLING = this.rolling.toString();\n    env.FLAKEHUB_PUSH_MIRROR = this.mirror.toString();\n\n    if (this.name !== null) {\n      env.FLAKEHUB_PUSH_NAME = this.name;\n    }\n\n    if (this.rollingMinor !== null) {\n      env.FLAKEHUB_PUSH_ROLLING_MINOR = this.rollingMinor.toString();\n    }\n\n    return env;\n  }\n\n  async push(): Promise<void> {\n    const executionEnv = await this.executionEnvironment();\n\n    const binary =\n      this.sourceBinary !== null\n        ? this.sourceBinary\n        : await this.idslib.fetchExecutable();\n\n    actionsCore.debug(\n      `execution environment: ${JSON.stringify(executionEnv, null, 2)}`,\n    );\n\n    const exitCode = await actionsExec.exec(\n      binary,\n      // We're setting this via flag for now due to a misspelling in the original environment variable.\n      // Remove this in favor of the environment variable only after PR #125 is merged.\n      [\"--visibility\", this.visibility],\n      {\n        env: {\n          ...executionEnv,\n          ...process.env, // To get PATH, etc.\n        },\n      },\n    );\n\n    if (exitCode !== 0) {\n      this.idslib.recordEvent(EVENT_EXECUTION_FAILURE, {\n        exitCode,\n      });\n      actionsCore.setFailed(`non-zero exit code of ${exitCode} detected`);\n    } else {\n      actionsCore.info(`Flake release was successfully published`);\n    }\n  }\n}\n\nfunction main(): void {\n  const flakeHubPush = new FlakeHubPushAction();\n\n  flakeHubPush.idslib.onMain(async () => {\n    await flakeHubPush.push();\n  });\n\n  flakeHubPush.idslib.execute();\n}\n\nmain();\n"],"mappings":"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","names":[]}